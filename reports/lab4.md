# Lab 4

做这个实验做了很久，主要是我没仔细看实验的说明，自己直接就照着测试函数去实现了，尤其是没注意到`sys_mmap`的`prot`和底层实现的`perm`的区别，忘了加`MapPermission::U`，导致调了好久，还动用了`IDA`和`GDB`。

另外一个坑点是要测试的程序很多，并且经由操作系统调度之后可能一个测试程序没运行完就运行另一个测试程序了，在终端上看到报错（尤其是访存异常这种）都不知道是哪个测试程序导致的，还要自己在测试程序中加打印语句。建议提供的测试程序能多输出一些信息，便于排错。

做这个实验比较麻烦的一点是原来通过`assert!(!pte.is_valid(), "vpn {:?} is mapped before mapping", vpn)`这一句话检查页面有没有被重复映射，而现在我们需要在检查到重复映射之后将错误结果一步步返回到用户态，就需要一路上相关函数都要返回`Result`，改动还是比较多的，但是做了改动之后其他的异常情况也就很容易处理了。不过相关的函数还是太多了，这里我只处理了跟用户态调用直接相关的函数，其他函数就把`Result`结果忽略了。感觉最好还是官方在创建的时候把所有的错误处理框架都提供好，省的所有人都要去大改这一部分。

还有就是现在的`map_addr`和`unmap_addr`具体处理都还是放到了`TaskManager`中，然后由一个全局的函数做代理，感觉这样各种功能全堆到`TaskManager`里面不太好。有想过让`TaskManager`直接返回一个`TaskControlBlock`得了，相关的处理都放到外面。不过一方面是这样处理相关的生命周期情况会有些棘手，另外也不确定这样设计本身是不是也不太好。

最后再记录下是怎么调试的吧。`QEMU`端只需要加`-S -s`参数就好了，不过默认情况下运行的是`Release`版的内核，各种函数内联、优化得面目全非，拿`IDA`也很难定位关键位置。然后就尝试怎么能编译出`Debug`版出来，研究了一下发现是可以`make test CHAPTER=4 MODE=debug`这样加`MODE`参数的，但这样只是启动`QEMU`的时候会加载`debug`目录下的内核，但其实并不会编译出`Debug`版本的内核出来。想要编译出`Debug`版还需要修改`overwrite/Makefile-ch3`，把`--release`删掉。

另外，在使用`GDB`调页表结构的时候，[gdb-pt-dump](https://github.com/martinradev/gdb-pt-dump)这个插件很好用。
